description: >-
  RSpec testing for a version of rails and ruby

parameters:
  rspec-root:
    type: string
    default: ""
    description: "Root location for RSpec files"
  rspec-system-args:
    type: string
    default: ""
    description: System arguments to pass through
  rspec-args:
    type: string
    default: ""
    description: RSpec arguments to pass through
  ruby-version:
    type: string
    description: Ruby version to test against
  rails-version:
    type: string
    description: Rails version to test against
  code-climate-report:
    type: boolean
    default: true
    description: Set to true when code climate should be reported
  database-migration:
    type: boolean
    default: false
    description: Set to true when the database needs to get migrated
  database-migration-command:
    type: string
    default: "bundle exec rails db:schema:load --trace"

executor:
  name: ruby-base
  ruby-version: << parameters.ruby-version >>

environment:
  BUNDLER_RAILS_VERSION: << parameters.rails-version >>

steps:
  - bundler-preamble:
      ruby-version: "<< parameters.ruby-version >>"
      additional-cache-tag: "<< parameters.rails-version >>"
  - when:
      condition: << parameters.database-migration >>
      steps:
        - run:
            name: Database Migration
            command: << parameters.database-migration-command >>
  - rspec-test:
      code-climate-report: << parameters.code-climate-report >>
      rspec-args: << parameters.rspec-args >>
      rspec-root: << parameters.rspec-root >>
      rspec-system-args: << parameters.rspec-system-args >>
