description: >-
  Need to test a matrix of ruby and rails versions? This is your 1 stop shop for that

parameters:
  rspec-root:
    type: string
    default: ""
    description: "Root location for RSpec files"
  rspec-system-args:
    type: string
    default: ""
    description: System arguments to pass through
  rspec-args:
    type: string
    default: ""
    description: RSpec arguments to pass through
  list-ruby-versions:
    type: steps
    default: [ "2.7.5", "3.0.0", "3.0.3", "3.1.1" ]
    description: List of ruby versions for the matrix of truth
  list-rails-versions:
    type: steps
    default: [ "~> 6.0.0", "~> 6" ]
    description: List of rails versions for the matrix of truth
  matrix-alias:
    type: string
    default: "required-matrix-tests"
    description: Matrix alias. Alias can be used to require all matrix versions in a test
  cc-report-collect-rails:
    type: string
    description: "Code climate will report when rails and ruby version matches. Enum from list-rails-versions"
    default: "~> 6.0.0"
  cc-report-collect-ruby:
    type: string
    description: "Code climate will report when rails and ruby version matches. Enum from list-ruby-versions"
    default: "3.0.0"
  database-migration:
    type: boolean
    default: false
    description: Set to true when the database needs to get migrated
  database-migration-command:
    type: string
    default: "bundle exec rails db:schema:load --trace"
  rspec-root:
    type: string
    default: ""
    description: "Root location for RSpec files"
  rspec-system-args:
    type: string
    default: ""
    description: System arguments to pass through
  rspec-args:
    type: string
    default: ""
    description: RSpec arguments to pass through

steps:
  - rspec-rails-ruby:
    cc-report-collect-ruby: << parameters.list-ruby-versions >>
    cc-report-collect-rails: << parameters.list-ruby-versions >>
    database-migration: << parameters.database-migration >>
    database-migration-command: << parameters.database-migration-command >>
    rspec-root: << parameters.rspec-root >>
    rspec-system-args: << parameters.rspec-system-args >>
    rspec-args: << parameters.rspec-args >>
    matrix:
      parameters:
        ruby-version: << parameters.list-ruby-versions >>
        rails-version: << parameters.list-rails-versions >>
      alias: << parameters.matrix-alias >>
      name: test-ruby<< matrix.ruby-version >>-rails<< matrix.rails-version >>
